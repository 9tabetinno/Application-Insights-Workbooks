{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "parameters": [
          {
            "id": "e3573799-27ef-4a2e-bf5b-62bbb4928c91",
            "version": "KqlParameterItem/1.0",
            "name": "DefaultSubscription_Internal",
            "type": 1,
            "isRequired": true,
            "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| take 1\r\n| project subscriptionId",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "dd40fb96-1319-4195-b788-3dd79aba1ea9",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "query": "summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)",
            "crossComponentResources": [
              "value::all"
            ],
            "value": "/subscriptions/5733bcb3-7fde-4caf-8629-41dc15e3b352",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "58e7fa93-9588-4aec-8bba-3879ef851948",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project id",
            "crossComponentResources": [
              "value::selected"
            ],
            "value": [
              "/subscriptions/e045cc0b-0eea-47e8-9176-28c8d2c109ac/resourceGroups/CH-OpsRG-Pri-Dev/providers/Microsoft.OperationalInsights/workspaces/CH-LA-Dev",
              "/subscriptions/5733bcb3-7fde-4caf-8629-41dc15e3b352/resourceGroups/CH-OpsRG-Pri/providers/Microsoft.OperationalInsights/workspaces/CH-LA"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "3d2b20e1-f5c9-4f6a-b0c2-5fb8ad5fd4d6",
            "version": "KqlParameterItem/1.0",
            "name": "resourceGroup",
            "type": 1,
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| where id == \"{Workspace}\"\r\n| project resourceGroup",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "51f4ef42-018a-48b9-a561-39bc3fcf883c",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "value": {
              "durationMs": 86400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "7e6c3264-1340-433c-98e9-118b37dc1efa",
            "version": "KqlParameterItem/1.0",
            "name": "GiBperday",
            "type": 1,
            "description": "Shows Average per Day over selected Duration (GiB)",
            "query": "union withsource = tt *\r\n| where TimeGenerated > startofday({TimeRange:start}) and TimeGenerated < startofday({TimeRange:end})\r\n// Only look at chargeable Tables\r\n| where _IsBillable == True\r\n| summarize\r\nTotalGBytes =round(sum(_BilledSize/(1024*1024*1024)),2)\r\nby bin(TimeGenerated, 1d)//, Solution=tt\r\n| summarize round(avg(TotalGBytes),2)\r\n",
            "crossComponentResources": [
              "{Workspace}"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "50b0f196-12ab-46d9-9b90-5372d82216a1",
            "version": "KqlParameterItem/1.0",
            "name": "GiBtotal",
            "type": 1,
            "query": "union withsource = tt *\r\n| where TimeGenerated {TimeRange:query}\r\n// Only look at chargeable Tables\r\n| where _IsBillable == True\r\n| summarize TotalGBytes =round(sum(_BilledSize/(1024*1024*1024)),2)",
            "isHiddenWhenLocked": true,
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          }
        ],
        "style": "above",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 17"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "3d439cda-4cb0-44e0-b054-2208218a3c3a",
            "cellValue": "SelectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Workspace Info",
            "subTarget": "Workspace Info",
            "style": "link"
          },
          {
            "id": "95790351-6000-4fdb-b16f-8c51b06443e9",
            "cellValue": "SelectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Usage",
            "subTarget": "Usage",
            "style": "link"
          },
          {
            "id": "9bd54326-1969-4acf-8b19-30ca2911e2f1",
            "cellValue": "SelectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Health",
            "subTarget": "Health",
            "style": "link"
          },
          {
            "id": "f2e130e4-7046-4577-adec-f9498f2b7348",
            "cellValue": "SelectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Query audit",
            "subTarget": "Query audit",
            "style": "link"
          },
          {
            "id": "d1ca3706-b8db-417c-a441-558a0f29a7bb",
            "cellValue": "SelectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Operations",
            "subTarget": "Operations",
            "style": "link"
          },
          {
            "id": "9ec18509-4326-4200-8ae1-033a0bf92928",
            "cellValue": "SelectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Change log",
            "subTarget": "Change log",
            "style": "link"
          }
        ]
      },
      "name": "links - 8"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces' \r\n| where id has \"{Workspace}\"\r\n| extend state = trim(' ', tostring(properties.provisioningState))\r\n\t\t,sku   = trim(' ', tostring(properties.sku.name))\r\n        ,skuUpdate = trim(' ', tostring(properties.sku.lastSkuUpdate))\r\n\t\t,retentionDays = trim(' ', tostring(properties.retentionInDays))\r\n\t\t,dailyquotaGB  = trim(' ', tostring(properties.workspaceCapping.dailyQuotaGb))\r\n| extend dailyquotaGB = iif(dailyquotaGB !=-1.0, dailyquotaGB,\"Not set\")\r\n| extend skuUpdate    = iif(strlen(skuUpdate) > 0, skuUpdate,\"Unknown\")\r\n| extend sentinel     = iif(toint(retentionDays) < 90,\"If you have Sentinel, you can change your retention to 90days (free)?\",\"\")\r\n| project ['Workspace Name']=id, ['Resource Group']=resourceGroup, location, ['Data Retention(days)']=retentionDays, ['Last known SKU update']=skuUpdate, ['Daily Data Cap']=dailyquotaGB, ['Licence']=sku, ['Notes'] = sentinel",
        "size": 1,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::selected"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Workspace Info"
      },
      "name": "query - 18"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union withsource=[\"$TableName\"] *\n| summarize Count=count() by TableName=[\"$TableName\"]\n| render barchart",
              "size": 1,
              "title": "Logs count by table",
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "name": "Logs count by table",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Heartbeat\n| project Computer | distinct Computer\n| order by Computer asc",
              "size": 0,
              "title": "Computers sending heartbeats",
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "Computer",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Computer",
                  "sortOrder": 1
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "SelectedTab",
              "comparison": "isEqualTo",
              "value": "Usage"
            },
            "name": "Computers sending heartbeats",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union withsource=TableName1 *\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize Entries = count(), Size = sum(_BilledSize), last_log = datetime_diff(\"second\",now(), max(TimeGenerated)), estimate  = sumif(_BilledSize, _IsBillable==true)  by TableName1, _IsBillable\r\n| project ['Table Name'] = TableName1, ['Table Size'] = Size, ['Table Entries'] = Entries,\r\n          ['Size per Entry'] = 1.0 * Size / Entries, ['IsBillable'] = _IsBillable, ['Last Record Received'] =  last_log \r\n | order by ['Table Size']  desc\r\n\r\n ",
              "size": 0,
              "showAnalytics": true,
              "title": "{Workspace:name} Status for {TimeRange:label}, Billable Tables have an  average use of: {GiBperday} GiB per day, Billable Tables have a Total size of {GiBtotal} GiB",
              "timeContext": {
                "durationMs": 86400000
              },
              "exportFieldName": "Table Name",
              "exportParameterName": "Table",
              "exportDefaultValue": "All Tables",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Table Size",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "coldHot"
                    },
                    "numberFormat": {
                      "unit": 2,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Table Entries",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "green"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Size per Entry",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "orange"
                    },
                    "numberFormat": {
                      "unit": 2,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "IsBillable",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "True",
                          "representation": "green",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "False",
                          "representation": "blueDark",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "blue",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Last Record Received",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "greenRed"
                    },
                    "numberFormat": {
                      "unit": 24,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Table Trend",
                    "formatter": 10,
                    "formatOptions": {
                      "palette": "redGreen"
                    }
                  }
                ],
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "Table Name"
                  },
                  {
                    "columnId": "Table Size",
                    "comment": "Capacity of the Table"
                  },
                  {
                    "columnId": "Table Entries",
                    "comment": "Count of Rows in the Table"
                  },
                  {
                    "columnId": "Size per Entry",
                    "comment": "Capacity of the Rows"
                  },
                  {
                    "columnId": "IsBillable",
                    "comment": "Is the Table Free or Billable?"
                  },
                  {
                    "columnId": "Last Record Received",
                    "comment": "When did the last record arrive?"
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedTab",
              "comparison": "isEqualTo",
              "value": "Usage"
            },
            "name": "BillableTablesVolume",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union withsource=TableName1 *\r\n| where '{Table}' == 'All Tables' or TableName1 == '{Table}'\r\n| make-series TableSize = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n| mvexpand TableSize to typeof(real), TimeGenerated to typeof(datetime) limit 1000\r\n| project TimeGenerated, ['{Table}'] = TableSize",
              "size": 0,
              "title": "Table Entries, count over time: {TimeRange:label}",
              "color": "green",
              "timeContext": {
                "durationMs": 86400000
              },
              "exportFieldName": "Namespace",
              "exportParameterName": "Namespace",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "areachart"
            },
            "customWidth": "50",
            "name": "TableEntriesCountOverTime"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union withsource=TableName1 *\r\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), Type\r\n| project Type, TimeGenerated, count_\r\n\r\n\r\n",
              "size": 1,
              "showAnalytics": true,
              "title": "Monthly Average Table Usage : Time Brush Enabled",
              "color": "blue",
              "timeContext": {
                "durationMs": 2592000000
              },
              "exportFieldName": "Namespace",
              "exportParameterName": "Namespace",
              "exportDefaultValue": "All",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "barchart"
            },
            "customWidth": "100",
            "name": "MonthlyAverageTableUsage"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union withsource=TableName1 *\r\n| summarize count() by TableName = TableName1, _ResourceId\r\n| order by count_ desc",
              "size": 1,
              "showAnalytics": true,
              "timeContext": {
                "durationMs": 86400000
              },
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "Namespace",
              "exportParameterName": "Namespace",
              "exportDefaultValue": "All",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "filter": true
              }
            },
            "name": "query - 17"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Usage"
      },
      "name": "Usage"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": []
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Performance"
      },
      "name": "Performance"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Counts by table names\nunion withsource=[\"$TableName\"] *\n// calculate ingestion duration in seconds\n| summarize AvgIngestionDurationSeconds = avg(ingestion_time()-TimeGenerated)/1s by SourceTableName=[\"$TableName\"], bin(TimeGenerated, 5m)\n| sort by TimeGenerated\n| summarize Timestamp=make_list(TimeGenerated), AvgIngestionDurationSeconds=make_list(AvgIngestionDurationSeconds) by SourceTableName\n| extend series_decompose_anomalies(AvgIngestionDurationSeconds)\n| mv-expand Timestamp to typeof(datetime), series_decompose_anomalies_AvgIngestionDurationSeconds_ad_score to typeof(int), series_decompose_anomalies_AvgIngestionDurationSeconds_baseline to typeof(int)\n| where series_decompose_anomalies_AvgIngestionDurationSeconds_baseline > 30\n| where series_decompose_anomalies_AvgIngestionDurationSeconds_ad_score > 3 or series_decompose_anomalies_AvgIngestionDurationSeconds_ad_score < -3\n| distinct SourceTableName\n\n",
        "size": 0,
        "title": "Data types showing ingestion latency spikes",
        "timeContext": {
          "durationMs": 14400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Health"
      },
      "name": "Data types showing ingestion latency spikes"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Heartbeat    // change table name as required\n| summarize AvgIngestionDurationSeconds = avg(ingestion_time()-TimeGenerated)/1s by bin(TimeGenerated, 5m)\n| render timechart \n",
        "size": 0,
        "title": "Heartbeats ingestion latency",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Health"
      },
      "customWidth": "50",
      "name": "Heartbeats ingestion latency",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// ingestion latency (E2E) per data type\r\nunion withsource=[\"$TableName\"] *\r\n| where [\"$TableName\"] !endswith \"_CL\" and [\"$TableName\"] != \"Usage\"\r\n| extend IngestionDurationSeconds = (ingestion_time()-TimeGenerated)/1s \r\n| summarize LatencyIngestion90Percentile=percentiles(IngestionDurationSeconds, 90) by SourceDataType=[\"$TableName\"], bin(TimeGenerated, 5m) \r\n| render timechart",
        "size": 0,
        "title": "Ingestion latency 90th percentile by data type (excl. usage and custom logs)",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Health"
      },
      "customWidth": "50",
      "name": "Ingestion latency 90th percentile by data type",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "//Agent latency trend (90th percentile)\r\nunion withsource=[\"$TableName\"] * \r\n| where [\"$TableName\"] !endswith \"_CL\" and [\"$TableName\"] != \"Usage\"\r\n| extend AgentLatencySeconds = (_TimeReceived-TimeGenerated)/1s \r\n| summarize percentile(AgentLatencySeconds, 90) by SourceDataType=[\"$TableName\"], bin(TimeGenerated,5m) \r\n| render timechart",
        "size": 0,
        "title": "Agent latecy 90th percentile by data type (excl. usage and custom logs)",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Health"
      },
      "customWidth": "50",
      "name": "Agent latecy 90th percentile by data type",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "//pipeline latency trend (90th percentile), last day\r\nunion withsource=[\"$TableName\"] * \r\n| where [\"$TableName\"] !endswith \"_CL\" and [\"$TableName\"] != \"Usage\"\r\n| extend PipeLineLatencySeconds = (ingestion_time()-_TimeReceived)/1s \r\n| summarize percentile(PipeLineLatencySeconds, 90) by [\"$TableName\"], bin(TimeGenerated,5m) \r\n| render timechart",
        "size": 0,
        "title": "Pipeline ingestion latency 90th percentile (excl. usage and custom logs)",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Health"
      },
      "customWidth": "50",
      "name": "Pipeline ingestion latency 90th percentile",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "LAQueryLogs\r\n| summarize count() by tostring(ResponseCode)\r\n| render piechart",
        "size": 1,
        "title": "Response Codes",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/LogAnalyticsUITelemetry/providers/Microsoft.OperationalInsights/workspaces/LAUXTelemetryLogsWorkspace",
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/noatestresourcegroup/providers/Microsoft.OperationalInsights/workspaces/noakupWS"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Query audit"
      },
      "customWidth": "30",
      "name": "ResponseCodes",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "LAQueryLogs\r\n| where TimeGenerated > ago(6h)\r\n| summarize AvgDuration= avg(ResponseDurationMs), MaxDuration=max(ResponseDurationMs), DevStd=stdev(ResponseDurationMs) by bin(TimeGenerated,10m)\r\n| render timechart",
        "size": 1,
        "title": "Query Duration",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/LogAnalyticsUITelemetry/providers/Microsoft.OperationalInsights/workspaces/LAUXTelemetryLogsWorkspace",
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/noatestresourcegroup/providers/Microsoft.OperationalInsights/workspaces/noakupWS"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Query audit"
      },
      "customWidth": "30",
      "name": "QueryDuration",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "LAQueryLogs\r\n| where TimeGenerated > ago(6h)\r\n| summarize avgRows=avg(ResponseRowCount), maxRows=max(ResponseRowCount), devstd=stdev(ResponseRowCount) by bin(TimeGenerated,10m)\r\n| render timechart",
        "size": 1,
        "title": "Number of rows returned by queries",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/LogAnalyticsUITelemetry/providers/Microsoft.OperationalInsights/workspaces/LAUXTelemetryLogsWorkspace",
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/noatestresourcegroup/providers/Microsoft.OperationalInsights/workspaces/noakupWS"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Query audit"
      },
      "customWidth": "30",
      "name": "QueryRows",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "LAQueryLogs\r\n| top-hitters 20 of QueryText by ResponseDurationMs\r\n| extend idx = indexof(QueryText,split(QueryText,\";\")[2])\r\n| extend purequerytext= substring(QueryText,idx)\r\n| project-away QueryText, idx",
        "size": 0,
        "title": "Top 20 slowest queries",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/LogAnalyticsUITelemetry/providers/Microsoft.OperationalInsights/workspaces/LAUXTelemetryLogsWorkspace",
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/noatestresourcegroup/providers/Microsoft.OperationalInsights/workspaces/noakupWS"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "approximate_sum_ResponseDurationMs",
              "formatter": 8,
              "formatOptions": {
                "palette": "redBright"
              }
            },
            {
              "columnMatch": "purequerytext",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "CellDetails",
                "linkIsContextBlade": true,
                "customColumnWidthSetting": "160ch"
              }
            },
            {
              "columnMatch": "QueryText",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "90%"
              }
            }
          ],
          "labelSettings": [
            {
              "columnId": "approximate_sum_ResponseDurationMs",
              "label": "Response Duration (ms)"
            },
            {
              "columnId": "purequerytext",
              "label": "Query Text"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Query audit"
      },
      "name": "SlowestQueries"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "LAQueryLogs\r\n| top 10 by StatsCPUTimeMs desc nulls last\r\n| extend purequerytext= split(QueryText, \";\")[2]\r\n| extend idx = indexof(QueryText,split(QueryText,\";\")[2])\r\n| project StatsCPUTimeMs, StatsDataProcessedKB, substring(QueryText,idx)",
        "size": 0,
        "showAnalytics": true,
        "title": "Top 10 resource intensive queries ",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/LogAnalyticsUITelemetry/providers/Microsoft.OperationalInsights/workspaces/LAUXTelemetryLogsWorkspace",
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/noatestresourcegroup/providers/Microsoft.OperationalInsights/workspaces/noakupWS"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "StatsCPUTimeMs",
              "formatter": 8,
              "formatOptions": {
                "palette": "redBright"
              }
            },
            {
              "columnMatch": "Column1",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "CellDetails",
                "linkIsContextBlade": true
              }
            },
            {
              "columnMatch": "purequerytext",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "160ch"
              }
            },
            {
              "columnMatch": "approximate_sum_ResponseDurationMs",
              "formatter": 8,
              "formatOptions": {
                "palette": "redBright",
                "customColumnWidthSetting": "15ch"
              }
            },
            {
              "columnMatch": "QueryText",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "90%"
              }
            }
          ],
          "labelSettings": [
            {
              "columnId": "StatsCPUTimeMs",
              "label": "CPU Time (ms)"
            },
            {
              "columnId": "StatsDataProcessedKB",
              "label": "Data Processed (kb)"
            },
            {
              "columnId": "Column1",
              "label": "Query Text"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Query audit"
      },
      "name": "ResourceIntensiveQueries "
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "LAQueryLogs\r\n| summarize count() by AADEmail\r\n| top 10 by count_\r\n",
        "size": 0,
        "showAnalytics": true,
        "title": "Queries by user",
        "timeContext": {
          "durationMs": 86400000
        },
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/LogAnalyticsUITelemetry/providers/Microsoft.OperationalInsights/workspaces/LAUXTelemetryLogsWorkspace",
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/noatestresourcegroup/providers/Microsoft.OperationalInsights/workspaces/noakupWS"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Query audit"
      },
      "customWidth": "50",
      "name": "QueriesByUser",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "LAQueryLogs\r\n| where ResponseCode == \"429\"\r\n| summarize reqCount = count() by AADObjectId\r\n| order by reqCount desc",
        "size": 0,
        "showAnalytics": true,
        "title": "Throttled users",
        "timeContext": {
          "durationMs": 86400000
        },
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/LogAnalyticsUITelemetry/providers/Microsoft.OperationalInsights/workspaces/LAUXTelemetryLogsWorkspace",
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/MeirSandbox/providers/Microsoft.OperationalInsights/workspaces/Contoso88",
          "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/noatestresourcegroup/providers/Microsoft.OperationalInsights/workspaces/noakupWS"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Query audit"
      },
      "customWidth": "50",
      "showPin": true,
      "name": "ThrottledUsers",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Operation\r\n| where OperationStatus in (\"Warning\", \"Error\")\r\n| summarize arg_max(TimeGenerated, *) by OperationStatus, OperationCategory, Solution, Computer, Detail\r\n| project TimeGenerated, OperationStatus, OperationCategory, Solution, Computer, Detail\r\n| sort by TimeGenerated asc",
        "size": 0,
        "title": "Top operational errors and warnings",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "TimeGenerated",
              "formatter": 5
            },
            {
              "columnMatch": "OperationStatus",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Warning",
                    "representation": "2",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "Error",
                    "representation": "3",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "success",
                    "text": "{0}{1}"
                  }
                ]
              },
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "decimal",
                  "useGrouping": false
                }
              }
            }
          ],
          "hierarchySettings": {
            "treeType": 1,
            "groupBy": [
              "Detail"
            ],
            "expandTopLevel": true,
            "finalBy": "TimeGenerated"
          },
          "sortBy": [
            {
              "itemKey": "$gen_count_$gen_group_0",
              "sortOrder": 1
            }
          ],
          "labelSettings": [
            {
              "columnId": "TimeGenerated"
            },
            {
              "columnId": "OperationStatus",
              "label": "Status"
            },
            {
              "columnId": "OperationCategory",
              "label": "Category"
            },
            {
              "columnId": "Solution"
            },
            {
              "columnId": "Computer"
            },
            {
              "columnId": "Detail",
              "label": "Details"
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "$gen_count_$gen_group_0",
            "sortOrder": 1
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "Operations"
      },
      "name": "TopOperationalErrorsAndWarnings"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/b1550e13-52b0-4ed1-8a7a-8929cee47022/resourceGroups/noatestresourcegroup/providers/Microsoft.OperationalInsights/workspaces/noakupWS"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}